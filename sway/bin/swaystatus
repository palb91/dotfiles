#!/usr/bin/env python

"""i3status wrapper."""

import os
import sys
import json
import re
from datetime import datetime

try:
    import psutil
    import notmuch
except ModuleNotFoundError:
    pass

try:
    from khal.settings    import get_config       as khal_get_cfg
    from khal.cli         import build_collection as khal_collection
    from khal.controllers import khal_list
except ModuleNotFoundError:
    pass


def print_line(line):
    """Output unbufferized."""
    sys.stdout.write(line + '\n')
    sys.stdout.flush()


def read_line():
    """Read standard input line by line."""
    return sys.stdin.readline().strip()


def format_icon(text):
    """Colorize the icon."""
    if len(text) == 0:
        return ''

    text = text.split()
    color = text.pop(0) if text[0][0] == '#' else '#FFFFFF'
    icon = '<span color="%s">%s</span>' % (color, text.pop(0))

    return '%s %s' % (icon, ' '.join(text))


def khal_view(bloc):
    """khal next event."""
    try:
        config   = khal_get_cfg()
        events   = khal_collection(config, 'work')
        datefmt  = config["locale"]["datetimeformat"]
        outfmt   = ' {start-time} {title}'
        dates    = str(datetime.now().strftime(datefmt)) + ' eod'
        khallist = khal_list(events, dates, config, outfmt)

        if len(khallist) > 0:
            text = re.compile(r'\x1b[^m]+m').sub('', khallist.pop())

            if text == 'No events':
                bloc['full_text'] = ''
            elif len(text) > 25:
                bloc['full_text'] = text[:20] + '…'
            else:
                bloc['full_text'] = text

    except Exception:
        bloc['full_text'] = '#F44 '

    return bloc


def run_watch(bloc):       return bloc
def ethernet(bloc):        return bloc
def wireless(bloc):        return bloc
def disk_info(bloc):       return bloc
def cpu_temperature(bloc): return bloc
def cpu_usage(bloc):       return bloc
def battery(bloc):         return bloc


def mails(bloc):
    """Get the count with notmuch."""
    if 'psutil' not in sys.modules or 'notmuch' not in sys.modules:
        return bloc

    def is_fetchmail_running():
        """Check status of process fetchmail."""
        pid_file = os.environ['XDG_RUNTIME_DIR'] + '/fetchmail.pid'
        with open(pid_file, 'r') as pid:
            fetchmail_pid = int(pid.readline().strip())
            for p in psutil.process_iter():
                if p.pid == fetchmail_pid and p.name() == 'fetchmail':
                    return True
                    break
        return False

    db_base = os.environ['XDG_DATA_HOME'] + '/mails/%s'
    query   = 'tag:inbox AND tag:unread AND NOT tag:killed'
    color   = {'work': '#7777FF', 'home': '#77BB77'}
    out     = ''
    icon    = ''
    style   = {'home': str.maketrans('0123456789', '⁰¹²³⁴⁵⁶⁷⁸⁹'),
               'work': str.maketrans('0123456789', '₀₁₂₃₄₅₆₇₈₉')}

    # Show if fetching mails
    try:
        if is_fetchmail_running():
            icon = ' '
    except FileNotFoundError:
        pass

    for account in ['work', 'home']:
        db_dir = db_base % account
        if not os.path.isdir(db_dir):
            continue

        db = notmuch.Database(path=db_dir)
        count = db.create_query(query).count_messages()
        db.close()

        if count == 0:
            continue

        count = str(count).translate(style[account])

        out += '<span color="%s">%s</span>' % (color[account], count)

    if icon == '':
        icon = '#FFFFFF  ' if out != '' else '#333333  '

    bloc['full_text'] = icon + out
    return bloc


def volume(bloc):
    """Remove the headset bloc if not plugged."""
    if 'AmazonBasics' in bloc['instance']:
        try:
            with open('/proc/asound/Headset/id', 'r'):
                pass
        except Exception:
            bloc['full_text'] = ''

    return bloc


def time(bloc):
    """Time: White on grey."""
    bloc['color']      = "#FFFFFF"
    bloc['background'] = '#222222'
    return bloc


if __name__ == '__main__':
    # Limit width for widgets
    widgets = ['cpu_usage', 'cpu_temperature', 'battery', 'run_watch']

    print_line(read_line())
    print_line(read_line())

    while True:
        line, prefix = read_line(), ''
        if line.startswith(','):
            line, prefix = line[1:], ','

        j = json.loads(line)

        j.insert(0, {'name': 'mails',     'full_text': ''})
        j.insert(0, {'name': 'khal_view', 'full_text': ''})

        for bloc in j:
            bloc['markup']    = 'pango'
            bloc['separator'] = False

            bloc['separator_block_width'] = 0 if bloc['name'] in widgets else 15

            # Update bloc with it's own named function
            bloc = globals()[bloc['name']](bloc)

            # Then update the icons (except for the time)
            if bloc['name'] != 'time':
                bloc['full_text'] = format_icon(bloc['full_text'])
            if bloc['name'] == 'battery':
                bloc['full_text'] = ' ' + bloc['full_text']

        print_line(prefix + json.dumps(j))
